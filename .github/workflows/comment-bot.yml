name: comment-bot
on:
  issue_comment:
    types:
      - created

defaults:
  run:
    shell: bash

permissions:
  pull-requests: write

jobs:
  bot:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - uses: actions/checkout@v4
      - name: Add label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          COMMENT_COMMANDS=$(echo ${COMMENT_BODY} | grep -Eo '/deploy|/lgtm|/approve|/redeploy|/test|/retest')
          AUTHORIZED=$(gh api repos/${{ github.repository }}/collaborators/${{ github.event.comment.user.login }}/permission --jq .user.permissions.maintain)
          if [[ ${AUTHORIZED} == "true" ]]; then
            for c in ${COMMENT_COMMANDS}; do
              gh issue edit ${{ github.event.issue.number }} --add-label "bot${c}"
            done
          else
            echo "Sorry, only maintainers are allowed to use slash commands."
          fi
