name: slasher
on:
  issue_comment:
    types: [created]
jobs:
  slasher:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Print Git Branch and Commit
        run: |
          echo "Git Branch and Commit:"
          echo "  Branch: ${{ github.ref }}"
          echo "  Commit: ${{ github.sha }}"
      - name: Print GitHub context
        run: |
          echo "GitHub Context:"
          echo "  Event Name: ${{ github.event_name }}"
          echo "  Event Path: ${{ github.event_path }}"
          echo "  Event Payload: ${{ toJson(github.event) }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Pull Request: ${{ github.event.pull_request }}"
      - name: Get PR merge commit SHA
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          PR_BRANCH=$(gh pr view ${{ github.event.issue.number }} --json headRefName --jq .headRefName)
          [ -n "$PR_BRANCH" ] && echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV || (echo "Failed to identify PR branch" && exit 1)
      - name: Slash command dispatch
        uses: peter-evans/slash-command-dispatch@v4
        with:
          token: ${{ secrets.SYSUSER_GITHUB_TOKEN }}
          reaction-token: ${{ secrets.SYSUSER_GITHUB_TOKEN }}
          issue-type: pull-request
          event-type-suffix: -deploy
          commands: |
            e2e
          dispatch-type: workflow
          static-args: |
            ref=${{ env.PR_BRANCH }}
