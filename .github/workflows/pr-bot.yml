name: pr-bot
on:
  pull_request:
    types:
      - opened
      - reopened
  issue_comment:
    types:
      - created

defaults:
  run:
    shell: bash

permissions:
  pull-requests: write

env:
  GITHUB_TOKEN: ${{ secrets.ADMIN_GITHUB_TOKEN }}

jobs:
  pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Add default label e2e-test/hold
        run: |
          if [ gh pr view ${{ github.event.number }} --json labels --jq .labels[].name | grep e2e-test ]; then
            gh issue edit ${{ github.event.number }} --add-label "e2e-test/hold"
          fi
  pr-comment:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request
    steps:
      - uses: actions/checkout@v4
      - id: authorize
        name: Check if user is authorized to use slash commands
        env:
          COMMENT_CREATOR: "${{ github.event.comment.user.login }}"
        run: |
          _authorized=$(gh api repos/${{ github.repository }}/collaborators/${COMMENT_CREATOR}/permission --jq .user.permissions.maintain)
          echo authorized=$_authorized >> $GITHUB_OUTPUT
          if [ $_authorized != "true" ]; then
            gh issue comment ${{ github.event.issue.number }} --body "Sorry @${COMMENT_CREATOR}, only maintainers are allowed to use slash commands."
          fi
      # /e2e-test
      # Transfer slash command to label
      - name: e2e-test
        if: steps.authorize.outputs.authorized == 'true'
        env:
          COMMENT_BODY: "${{ github.event.comment.body }}"
        run: |
          _regex="\/e2e-test (hold|auto|skip)"
          if [[ ${COMMENT_BODY} =~ ${_regex} ]]; then
            _new="e2e-test/${BASH_REMATCH[1]}"
            echo $_new
            _old=$(gh pr view 10 --json labels --jq .labels[].name | grep 'e2e-test/')
            echo $_old
            _delete=${_old[@]/$_new} && _delete=$(echo $_delete | tr ' ' ,)
            echo $_delete
            # gh issue edit ${{ github.event.issue.number }} --add-label "${_new}" --remove-label "${_delete}"
          fi
